---
- name: Build chain for VirtualBox Guest Additions.
  yum: name={{ item }} state=present
  with_items:
    - bzip2
    - dkms
    - gcc
    - make
    - yum-plugin-versionlock
- name: Lock kernel version
  command: yum versionlock kernel
- name: Identify installed kernels
  shell: >
    rpm -qa kernel | cut -d '-' -f 2,3
  register: get_installed_kernel_versions
- name: Identify latest installed VirtualBox Guest Additions source
  shell: >
    find /usr/src -maxdepth 1 -name "vboxguest-*" -exec basename "{}" \; | sort | tail -1 | cut -d '-' -f 2
  register: get_vboxguest_version
- name: Yum devel package for each installed kernel
  yum:
    name: "kernel-devel-{{ item }}"
    state: present
  with_items: "{{ get_installed_kernel_versions.stdout_lines }}"
  ignore_errors: yes
- name: Yum headers package for each installed kernel
  yum:
    name: "kernel-headers-{{ item }}"
    state: present
  with_items: "{{ get_installed_kernel_versions.stdout_lines }}"
  ignore_errors: yes
- name: Start DKMS on boot
  service:
    name: dkms
    state: started
    enabled: yes
- name: DKMS add vboxguest
  command: >
    dkms add -m vboxguest -v {{ get_vboxguest_version.stdout }} --all
  ignore_errors: yes
- name: DKMS autoinstall
  command: dkms autoinstall
  ignore_errors: yes
- name: Make sure virtualbox kernel modules load on reboot
  copy:
    src: virtualbox.conf
    dest: /etc/modules-load.d/virtualbox.conf
    owner: root
    group: root
    mode: 0644
